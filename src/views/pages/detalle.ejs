<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= funcionalidad.title %> - Newsletter Unitrade</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>
<body>
    <%- include('../partials/header', { activeMenu: '', adminSession: typeof adminSession !== 'undefined' ? adminSession : false }) %>
    
    <main class="main-content">
        <div class="one-page-container">
            <% if (typeof isNew === 'undefined' || !isNew) { %>
            <div class="one-page-header">
                <div class="one-page-meta">
                    <span class="one-page-section">
                        <% 
                        const typeLabels = {
                            'catalogo': 'CATÁLOGO',
                            'newsletter': 'NEWSLETTER',
                            'proximamente': 'PRÓXIMAMENTE'
                        };
                        const typeLabel = typeLabels[funcionalidad.type] || 'PRODUCTS';
                        %>
                        <%= typeLabel %> > <%= funcionalidad.section.toUpperCase() %>
                    </span>
                </div>
                <h1 class="one-page-title">
                    <% if (funcionalidad.icon) { %>
                        <% if (funcionalidad.icon.startsWith('data:image')) { %>
                        <img src="<%= funcionalidad.icon %>" style="margin-right: 12px; width: 40px; height: 40px; vertical-align: middle; object-fit: contain;" alt="Icono">
                        <% } else if (funcionalidad.icon.startsWith('material-icons:')) { %>
                        <% const materialIconName = funcionalidad.icon.split(':')[1]; %>
                        <span class="material-icons" style="margin-right: 12px; font-size: 40px; vertical-align: middle;"><%= materialIconName %></span>
                        <% } else { %>
                        <i class="<%= funcionalidad.icon %>" style="margin-right: 12px; font-size: 40px; vertical-align: middle;"></i>
                        <% } %>
                    <% } %>
                    <%= funcionalidad.title %>
                </h1>
            </div>
            
            <div class="one-page-content">
                <% if (funcionalidad.description) { %>
                <div class="one-page-section">
                    <div class="one-page-section-content">
                        <%= funcionalidad.description ? funcionalidad.description.replace(/\n/g, '<br>') : 'Sin descripción disponible.' %>
                    </div>
                </div>
                <% } %>

                <% 
                let alcance = [];
                if (funcionalidad.alcance) {
                    try {
                        if (typeof funcionalidad.alcance === 'string') {
                            const parsed = JSON.parse(funcionalidad.alcance || '[]');
                            alcance = Array.isArray(parsed) ? parsed : [];
                        } else if (Array.isArray(funcionalidad.alcance)) {
                            alcance = funcionalidad.alcance;
                        }
                    } catch (e) {
                        alcance = [];
                    }
                }
                if (alcance.length > 0) {
                %>
                <div class="one-page-section">
                    <h2 class="one-page-section-title">Alcance</h2>
                    <div class="one-page-section-content">
                        <div class="alcance-cards-grid">
                            <% alcance.forEach((item, index) => { %>
                            <div class="alcance-card <%= item.titulo ? 'alcance-card-with-title' : '' %>">
                                <div class="alcance-card-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                </div>
                                <% if (item.titulo) { %>
                                <h3 class="alcance-card-title"><%= item.titulo %></h3>
                                <% } %>
                                <div class="alcance-card-content">
                                    <p class="alcance-card-text"><%= item.descripcion || item.description || '' %></p>
                                </div>
                            </div>
                            <% }); %>
                        </div>
                        <% if (funcionalidad.alcance_imagen) { %>
                        <div class="alcance-section-image" style="margin-top: 32px;">
                            <img src="<%= funcionalidad.alcance_imagen %>" alt="Alcance" style="width: 100%; max-height: 400px; object-fit: contain; border-radius: 12px; border: 1px solid rgba(26, 115, 232, 0.2);" />
                        </div>
                        <% } %>
                    </div>
                </div>
                <% } %>

                <% 
                let ventajas = [];
                if (funcionalidad.ventajas_esperadas) {
                    try {
                        if (typeof funcionalidad.ventajas_esperadas === 'string') {
                            const parsed = JSON.parse(funcionalidad.ventajas_esperadas || '[]');
                            ventajas = Array.isArray(parsed) ? parsed : [];
                        } else if (Array.isArray(funcionalidad.ventajas_esperadas)) {
                            ventajas = funcionalidad.ventajas_esperadas;
                        }
                    } catch (e) {
                        ventajas = [];
                    }
                }
                if (ventajas.length > 0) {
                %>
                <div class="one-page-section">
                    <h2 class="one-page-section-title">Ventajas esperadas</h2>
                    <div class="one-page-section-content">
                        <ul class="tags-list">
                            <% ventajas.forEach(item => { %>
                            <li class="tag-item">
                                <h3 class="tag-title"><%= item.titulo || item.title || '' %></h3>
                                <p class="tag-description"><%= item.descripcion || item.description || '' %></p>
                            </li>
                            <% }); %>
                        </ul>
                    </div>
                </div>
                <% } %>

                <% 
                let partes = [];
                if (funcionalidad.partes_interesadas) {
                    try {
                        if (typeof funcionalidad.partes_interesadas === 'string') {
                            const parsed = JSON.parse(funcionalidad.partes_interesadas || '[]');
                            partes = Array.isArray(parsed) ? parsed : [];
                        } else if (Array.isArray(funcionalidad.partes_interesadas)) {
                            partes = funcionalidad.partes_interesadas;
                        }
                    } catch (e) {
                        partes = [];
                    }
                }
                if (partes.length > 0) {
                %>
                <div class="one-page-section">
                    <h2 class="one-page-section-title">Partes interesadas</h2>
                    <div class="one-page-section-content">
                        <ul class="stakeholders-list">
                            <% partes.forEach(parte => { %>
                            <li class="stakeholder-item">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="checked">
                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                </svg>
                                <span><%= parte %></span>
                            </li>
                            <% }); %>
                        </ul>
                    </div>
                </div>
                <% } %>
            </div>
            <% } %>
            
            <% if (typeof isNew === 'undefined' || !isNew) { %>
            <div class="one-page-footer">
                <h3 class="one-page-footer-title">INFORMACIÓN DE CONTACTO</h3>
                <div class="one-page-footer-contacts">
                    <a href="mailto:comercial@mercapsoftware.com" class="contact-link">comercial@mercapsoftware.com</a>
                    <a href="mailto:s.sherman@mercapsoftware.com" class="contact-link">s.sherman@mercapsoftware.com</a>
                    <a href="mailto:p.biscione@mercapsoftware.com" class="contact-link">p.biscione@mercapsoftware.com</a>
                </div>
            </div>
            <% } %>

            <div class="one-page-actions">
                <% if (typeof adminSession !== 'undefined' && adminSession) { %>
                    <% if (typeof isNew !== 'undefined' && isNew) { %>
                    <button onclick="javascript:history.back()" class="btn">← Cancelar</button>
                    <% } else { %>
                    <button onclick="toggleEditMode()" class="button" id="editBtn">Editar</button>
                    <% } %>
                <% } %>
                <a href="javascript:history.back()" class="btn">← Volver</a>
            </div>

            <!-- Formulario de edición (oculto por defecto, o visible si es nueva o editMode) -->
            <div id="editForm" style="<%= (typeof isNew !== 'undefined' && isNew) || (typeof editMode !== 'undefined' && editMode) ? 'display: block;' : 'display: none;' %> margin-top: 32px; padding-top: 32px; border-top: 2px solid var(--border-color);">
                <h2 class="one-page-section-title"><%= (typeof isNew !== 'undefined' && isNew) ? 'Nueva Funcionalidad' : 'Editar Funcionalidad' %></h2>
                <% if (typeof isNew === 'undefined' || !isNew) { %>
                <h3 style="font-size: 24px; font-weight: 400; color: var(--text-primary); margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                    <% if (funcionalidad.icon) { %>
                        <% if (funcionalidad.icon.startsWith('data:image')) { %>
                        <img src="<%= funcionalidad.icon %>" style="margin-right: 12px; width: 32px; height: 32px; vertical-align: middle; object-fit: contain;" alt="Icono">
                        <% } else if (funcionalidad.icon.startsWith('material-icons:')) { %>
                        <% const materialIconName2 = funcionalidad.icon.split(':')[1]; %>
                        <span class="material-icons" style="margin-right: 12px; font-size: 32px; vertical-align: middle;"><%= materialIconName2 %></span>
                        <% } else { %>
                        <i class="<%= funcionalidad.icon %>" style="margin-right: 12px; font-size: 32px; vertical-align: middle;"></i>
                        <% } %>
                    <% } %>
                    <%= funcionalidad.title %>
                </h3>
                <% } %>
                <form id="editFunctionalityForm" onsubmit="guardarEdicion(event)">
                    <input type="hidden" id="editId" value="<%= funcionalidad.id || '' %>">
                    <input type="hidden" id="isNew" value="<%= (typeof isNew !== 'undefined' && isNew) ? 'true' : 'false' %>">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary);">Tipo *</label>
                            <select id="editType" name="type" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; font-family: 'Google Sans', 'Roboto', sans-serif;">
                                <option value="catalogo" <%= funcionalidad.type === 'catalogo' ? 'selected' : '' %>>Catálogo</option>
                                <option value="newsletter" <%= funcionalidad.type === 'newsletter' ? 'selected' : '' %>>Newsletter</option>
                                <option value="proximamente" <%= funcionalidad.type === 'proximamente' ? 'selected' : '' %>>Próximamente</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary);">Sección *</label>
                            <select id="editSection" name="section" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; font-family: 'Google Sans', 'Roboto', sans-serif;">
                                <option value="Operatorias" <%= funcionalidad.section === 'Operatorias' ? 'selected' : '' %>>Operatorias</option>
                                <option value="Backoffice" <%= funcionalidad.section === 'Backoffice' ? 'selected' : '' %>>Backoffice</option>
                                <option value="Market Data" <%= funcionalidad.section === 'Market Data' ? 'selected' : '' %>>Market Data</option>
                                <option value="Valuacion y Contabilidad" <%= funcionalidad.section === 'Valuacion y Contabilidad' ? 'selected' : '' %>>Valuación y Contabilidad</option>
                                <option value="Reportes/Interfaces" <%= funcionalidad.section === 'Reportes/Interfaces' ? 'selected' : '' %>>Reportes/Interfaces</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary);">Título *</label>
                        <input type="text" id="editTitle" name="title" required value="<%= funcionalidad.title || '' %>" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; font-family: 'Google Sans', 'Roboto', sans-serif;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary);">Descripción</label>
                        <textarea id="editDescription" name="description" rows="5" lang="es" spellcheck="true" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; font-family: 'Google Sans', 'Roboto', sans-serif;"><%= funcionalidad.description || '' %></textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary);">Alcance</label>
                        <div id="alcanceContainer" style="margin-bottom: 12px;">
                            <% 
                            let alcanceEdit = [];
                            if (funcionalidad.alcance) {
                                try {
                                    if (typeof funcionalidad.alcance === 'string') {
                                        const parsed = JSON.parse(funcionalidad.alcance || '[]');
                                        alcanceEdit = Array.isArray(parsed) ? parsed : [];
                                    } else if (Array.isArray(funcionalidad.alcance)) {
                                        alcanceEdit = funcionalidad.alcance;
                                    }
                                } catch (e) {
                                    alcanceEdit = [];
                                }
                            }
                            alcanceEdit.forEach((item, index) => {
                            %>
                            <div class="tag-edit-item" style="margin-bottom: 12px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--hover-bg);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: 500; font-size: 13px;">Tag <%= index + 1 %></span>
                                    <button type="button" onclick="eliminarTagAlcance(this)" style="background: #d93025; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Eliminar</button>
                                </div>
                                <input type="text" class="tag-titulo-alcance" placeholder="Título (opcional)" value="<%= item.titulo || '' %>" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px; font-size: 14px; font-family: 'Google Sans', 'Roboto', sans-serif;">
                                <textarea class="tag-descripcion" placeholder="Descripción" rows="2" lang="es" spellcheck="true" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; font-family: 'Google Sans', 'Roboto', sans-serif;"><%= item.descripcion || item.description || '' %></textarea>
                            </div>
                            <% }); %>
                        </div>
                        <button type="button" onclick="agregarTagAlcance()" class="btn" style="width: 100%; margin-bottom: 16px;">+ Agregar Tag de Alcance</button>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary);">Imagen de Alcance (opcional)</label>
                            <input type="file" id="alcanceSectionImage" accept="image/*" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; font-family: 'Google Sans', 'Roboto', sans-serif;" onchange="previewAlcanceSectionImage(this)">
                            <input type="hidden" id="alcanceSectionImageData" value="<%= funcionalidad.alcance_imagen || '' %>">
                            <div id="alcanceSectionImagePreview" style="margin-top: 12px; <%= funcionalidad.alcance_imagen ? '' : 'display: none;' %>">
                                <img id="alcanceSectionImagePreviewImg" src="<%= funcionalidad.alcance_imagen || '' %>" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid var(--border-color);" />
                                <button type="button" onclick="eliminarAlcanceSectionImage()" style="margin-top: 8px; padding: 6px 12px; background: #d93025; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">Eliminar imagen</button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary);">Ventajas esperadas</label>
                        <div id="ventajasContainer" style="margin-bottom: 12px;">
                            <% 
                            let ventajasEdit = [];
                            if (funcionalidad.ventajas_esperadas) {
                                try {
                                    if (typeof funcionalidad.ventajas_esperadas === 'string') {
                                        const parsed = JSON.parse(funcionalidad.ventajas_esperadas || '[]');
                                        ventajasEdit = Array.isArray(parsed) ? parsed : [];
                                    } else if (Array.isArray(funcionalidad.ventajas_esperadas)) {
                                        ventajasEdit = funcionalidad.ventajas_esperadas;
                                    }
                                } catch (e) {
                                    ventajasEdit = [];
                                }
                            }
                            ventajasEdit.forEach((item, index) => {
                            %>
                            <div class="tag-edit-item" style="margin-bottom: 12px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--hover-bg);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: 500; font-size: 13px;">Tag <%= index + 1 %></span>
                                    <button type="button" onclick="eliminarTagVentajas(this)" style="background: #d93025; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Eliminar</button>
                                </div>
                                <input type="text" class="tag-titulo" placeholder="Título" value="<%= item.titulo || item.title || '' %>" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px; font-size: 14px;">
                                <textarea class="tag-descripcion" placeholder="Descripción" rows="2" lang="es" spellcheck="true" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; font-family: 'Google Sans', 'Roboto', sans-serif;"><%= item.descripcion || item.description || '' %></textarea>
                            </div>
                            <% }); %>
                        </div>
                        <button type="button" onclick="agregarTagVentajas()" class="btn" style="width: 100%;">+ Agregar Tag de Ventajas</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary);">Partes Interesadas</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; padding: 16px; background: var(--hover-bg); border-radius: 8px;">
                            <% 
                            let partesEdit = [];
                            if (funcionalidad.partes_interesadas) {
                                try {
                                    if (typeof funcionalidad.partes_interesadas === 'string') {
                                        const parsed = JSON.parse(funcionalidad.partes_interesadas || '[]');
                                        partesEdit = Array.isArray(parsed) ? parsed : [];
                                    } else if (Array.isArray(funcionalidad.partes_interesadas)) {
                                        partesEdit = funcionalidad.partes_interesadas;
                                    }
                                } catch (e) {
                                    partesEdit = [];
                                }
                            }
                            const todasPartes = ['Sistemas', 'HomeBanking', 'Backoffice', 'Contabilidad', 'Mesa de dinero', 'Impuestos'];
                            todasPartes.forEach(parte => {
                                const activa = partesEdit.includes(parte) || (Array.isArray(partesEdit) && partesEdit.some(p => p.toLowerCase() === parte.toLowerCase()));
                            %>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='white'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" class="stakeholder-checkbox" value="<%= parte %>" <%= activa ? 'checked' : '' %> style="cursor: pointer;">
                                <span style="font-size: 14px;"><%= parte %></span>
                            </label>
                            <% }); %>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary);">Ícono</label>
                        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
                            <input type="text" id="editIcon" name="icon" value="<%= funcionalidad.icon || '' %>" placeholder="Ej: fas fa-chart-line" style="flex: 1; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; font-family: 'Google Sans', 'Roboto', sans-serif;">
                            <button type="button" onclick="abrirSelectorIconos()" class="btn" style="min-width: auto;">Seleccionar Icono</button>
                        </div>
                        <div id="iconPreview" style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--hover-bg); border-radius: 4px; min-height: 40px;">
                            <% if (funcionalidad.icon) { %>
                                <% if (funcionalidad.icon.startsWith('data:image')) { %>
                                <img src="<%= funcionalidad.icon %>" style="max-width: 48px; max-height: 48px; object-fit: contain;" alt="Icono PNG">
                                <span style="font-size: 13px; color: var(--text-secondary);">Icono PNG importado</span>
                                <% } else if (funcionalidad.icon.startsWith('material-icons:')) { %>
                                <% const materialIconName3 = funcionalidad.icon.split(':')[1]; %>
                                <span class="material-icons" style="font-size: 24px; color: var(--primary-color);"><%= materialIconName3 %></span>
                                <span style="font-size: 13px; color: var(--text-secondary);"><%= funcionalidad.icon %></span>
                                <% } else { %>
                                <i class="<%= funcionalidad.icon %>" style="font-size: 24px; color: var(--primary-color);"></i>
                                <span style="font-size: 13px; color: var(--text-secondary);"><%= funcionalidad.icon %></span>
                                <% } %>
                            <% } else { %>
                            <span style="font-size: 13px; color: var(--text-secondary);">Ningún icono seleccionado</span>
                            <% } %>
                        </div>
                    </div>
                    
                    <!-- Modal de selector de iconos -->
                    <div id="iconSelectorModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 3000; overflow-y: auto;">
                        <div style="background: white; margin: 40px auto; max-width: 800px; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 20px; font-weight: 500; color: var(--text-primary);">Seleccionar Icono</h3>
                                <button onclick="cerrarSelectorIconos()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <input type="text" id="iconSearch" placeholder="Buscar icono..." style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; margin-bottom: 12px;" oninput="filtrarIconos()">
                                <div style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--hover-bg); border-radius: 4px;">
                                    <label for="iconFileUpload" style="cursor: pointer; font-size: 14px; color: var(--primary-color); display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-upload" style="font-size: 16px;"></i>
                                        <span>Importar icono PNG desde PC</span>
                                    </label>
                                    <input type="file" id="iconFileUpload" accept="image/png" style="display: none;" onchange="cargarIconoPNG(event)">
                                </div>
                            </div>
                            <div id="iconGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto; padding: 8px;">
                                <!-- Iconos de tecnología, finanzas, inversiones e informática -->
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-server')" title="Server"><i class="fas fa-server"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-database')" title="Database"><i class="fas fa-database"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-line')" title="Chart Line"><i class="fas fa-chart-line"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-bar')" title="Chart Bar"><i class="fas fa-chart-bar"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-pie')" title="Chart Pie"><i class="fas fa-chart-pie"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-dollar-sign')" title="Dollar"><i class="fas fa-dollar-sign"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-coins')" title="Coins"><i class="fas fa-coins"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-wallet')" title="Wallet"><i class="fas fa-wallet"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-credit-card')" title="Credit Card"><i class="fas fa-credit-card"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-exchange-alt')" title="Exchange"><i class="fas fa-exchange-alt"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-calculator')" title="Calculator"><i class="fas fa-calculator"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-file-invoice-dollar')" title="Invoice"><i class="fas fa-file-invoice-dollar"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-briefcase')" title="Briefcase"><i class="fas fa-briefcase"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-building')" title="Building"><i class="fas fa-building"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-network-wired')" title="Network"><i class="fas fa-network-wired"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-cloud')" title="Cloud"><i class="fas fa-cloud"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-shield-alt')" title="Shield"><i class="fas fa-shield-alt"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-lock')" title="Lock"><i class="fas fa-lock"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-key')" title="Key"><i class="fas fa-key"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-code')" title="Code"><i class="fas fa-code"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-cog')" title="Settings"><i class="fas fa-cog"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-tools')" title="Tools"><i class="fas fa-tools"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-sync')" title="Sync"><i class="fas fa-sync"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-robot')" title="Robot"><i class="fas fa-robot"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-microchip')" title="Microchip"><i class="fas fa-microchip"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-mobile-alt')" title="Mobile"><i class="fas fa-mobile-alt"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-desktop')" title="Desktop"><i class="fas fa-desktop"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-laptop')" title="Laptop"><i class="fas fa-laptop"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-tablet-alt')" title="Tablet"><i class="fas fa-tablet-alt"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-print')" title="Print"><i class="fas fa-print"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-file-alt')" title="File"><i class="fas fa-file-alt"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-folder')" title="Folder"><i class="fas fa-folder"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-archive')" title="Archive"><i class="fas fa-archive"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-search')" title="Search"><i class="fas fa-search"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-filter')" title="Filter"><i class="fas fa-filter"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-sort')" title="Sort"><i class="fas fa-sort"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-bell')" title="Bell"><i class="fas fa-bell"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-envelope')" title="Envelope"><i class="fas fa-envelope"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-paper-plane')" title="Paper Plane"><i class="fas fa-paper-plane"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-check-circle')" title="Check Circle"><i class="fas fa-check-circle"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-times-circle')" title="Times Circle"><i class="fas fa-times-circle"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-info-circle')" title="Info Circle"><i class="fas fa-info-circle"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-exclamation-circle')" title="Exclamation"><i class="fas fa-exclamation-circle"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-question-circle')" title="Question"><i class="fas fa-question-circle"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-user')" title="User"><i class="fas fa-user"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-users')" title="Users"><i class="fas fa-users"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-user-shield')" title="User Shield"><i class="fas fa-user-shield"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-handshake')" title="Handshake"><i class="fas fa-handshake"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-globe')" title="Globe"><i class="fas fa-globe"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-link')" title="Link"><i class="fas fa-link"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-unlink')" title="Unlink"><i class="fas fa-unlink"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-download')" title="Download"><i class="fas fa-download"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-upload')" title="Upload"><i class="fas fa-upload"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-save')" title="Save"><i class="fas fa-save"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-edit')" title="Edit"><i class="fas fa-edit"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-trash')" title="Trash"><i class="fas fa-trash"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-copy')" title="Copy"><i class="fas fa-copy"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-paste')" title="Paste"><i class="fas fa-paste"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-cut')" title="Cut"><i class="fas fa-cut"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-redo')" title="Redo"><i class="fas fa-redo"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-undo')" title="Undo"><i class="fas fa-undo"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-history')" title="History"><i class="fas fa-history"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-clock')" title="Clock"><i class="fas fa-clock"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-calendar')" title="Calendar"><i class="fas fa-calendar"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-calendar-alt')" title="Calendar Alt"><i class="fas fa-calendar-alt"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-calendar-check')" title="Calendar Check"><i class="fas fa-calendar-check"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-stopwatch')" title="Stopwatch"><i class="fas fa-stopwatch"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-hourglass')" title="Hourglass"><i class="fas fa-hourglass"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-tachometer-alt')" title="Tachometer"><i class="fas fa-tachometer-alt"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-bolt')" title="Bolt"><i class="fas fa-bolt"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-fire')" title="Fire"><i class="fas fa-fire"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-star')" title="Star"><i class="fas fa-star"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-gem')" title="Gem"><i class="fas fa-gem"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-trophy')" title="Trophy"><i class="fas fa-trophy"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-medal')" title="Medal"><i class="fas fa-medal"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-award')" title="Award"><i class="fas fa-award"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-certificate')" title="Certificate"><i class="fas fa-certificate"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-graduation-cap')" title="Graduation Cap"><i class="fas fa-graduation-cap"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-book')" title="Book"><i class="fas fa-book"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-book-open')" title="Book Open"><i class="fas fa-book-open"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-bookmark')" title="Bookmark"><i class="fas fa-bookmark"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-tag')" title="Tag"><i class="fas fa-tag"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-tags')" title="Tags"><i class="fas fa-tags"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-flag')" title="Flag"><i class="fas fa-flag"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-flag-checkered')" title="Flag Checkered"><i class="fas fa-flag-checkered"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-map-marker-alt')" title="Map Marker"><i class="fas fa-map-marker-alt"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-compass')" title="Compass"><i class="fas fa-compass"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-directions')" title="Directions"><i class="fas fa-directions"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-route')" title="Route"><i class="fas fa-route"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-road')" title="Road"><i class="fas fa-road"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-sign')" title="Sign"><i class="fas fa-sign"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-traffic-light')" title="Traffic Light"><i class="fas fa-traffic-light"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-stop')" title="Stop"><i class="fas fa-stop"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-play')" title="Play"><i class="fas fa-play"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-pause')" title="Pause"><i class="fas fa-pause"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-forward')" title="Forward"><i class="fas fa-forward"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-backward')" title="Backward"><i class="fas fa-backward"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-step-forward')" title="Step Forward"><i class="fas fa-step-forward"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-step-backward')" title="Step Backward"><i class="fas fa-step-backward"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-fast-forward')" title="Fast Forward"><i class="fas fa-fast-forward"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-fast-backward')" title="Fast Backward"><i class="fas fa-fast-backward"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-eject')" title="Eject"><i class="fas fa-eject"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-power-off')" title="Power Off"><i class="fas fa-power-off"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-plug')" title="Plug"><i class="fas fa-plug"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-battery-full')" title="Battery Full"><i class="fas fa-battery-full"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-battery-half')" title="Battery Half"><i class="fas fa-battery-half"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-battery-empty')" title="Battery Empty"><i class="fas fa-battery-empty"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-battery-quarter')" title="Battery Quarter"><i class="fas fa-battery-quarter"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-battery-three-quarters')" title="Battery Three Quarters"><i class="fas fa-battery-three-quarters"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-charging-station')" title="Charging Station"><i class="fas fa-charging-station"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-gas-pump')" title="Gas Pump"><i class="fas fa-gas-pump"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-oil-can')" title="Oil Can"><i class="fas fa-oil-can"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-fill-drip')" title="Fill Drip"><i class="fas fa-fill-drip"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-tint')" title="Tint"><i class="fas fa-tint"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-fill')" title="Fill"><i class="fas fa-fill"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-spray-can')" title="Spray Can"><i class="fas fa-spray-can"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-paint-brush')" title="Paint Brush"><i class="fas fa-paint-brush"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-paint-roller')" title="Paint Roller"><i class="fas fa-paint-roller"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-palette')" title="Palette"><i class="fas fa-palette"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-magic')" title="Magic"><i class="fas fa-magic"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-wand-magic')" title="Wand Magic"><i class="fas fa-wand-magic"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-hat-wizard')" title="Hat Wizard"><i class="fas fa-hat-wizard"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-scroll')" title="Scroll"><i class="fas fa-scroll"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-scroll-old')" title="Scroll Old"><i class="fas fa-scroll-old"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-book-dead')" title="Book Dead"><i class="fas fa-book-dead"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-skull')" title="Skull"><i class="fas fa-skull"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-ghost')" title="Ghost"><i class="fas fa-ghost"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-spider')" title="Spider"><i class="fas fa-spider"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-cat')" title="Cat"><i class="fas fa-cat"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-dog')" title="Dog"><i class="fas fa-dog"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-dove')" title="Dove"><i class="fas fa-dove"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-crow')" title="Crow"><i class="fas fa-crow"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-fish')" title="Fish"><i class="fas fa-fish"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-frog')" title="Frog"><i class="fas fa-frog"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-hippo')" title="Hippo"><i class="fas fa-hippo"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-horse')" title="Horse"><i class="fas fa-horse"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-paw')" title="Paw"><i class="fas fa-paw"></i></div>
                                
                                <!-- Iconos adicionales: Tecnología, Finanzas, Servidores, Market Data, Mercado de Capitales -->
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-area')" title="Chart Area"><i class="fas fa-chart-area"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-candlestick')" title="Chart Candlestick"><i class="fas fa-chart-candlestick"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-trending-up')" title="Trending Up"><i class="fas fa-trending-up"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-trending-down')" title="Trending Down"><i class="fas fa-trending-down"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-line')" title="Chart Line"><i class="fas fa-chart-line"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-money-bill-wave')" title="Money Bill Wave"><i class="fas fa-money-bill-wave"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-money-check')" title="Money Check"><i class="fas fa-money-check"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-money-check-alt')" title="Money Check Alt"><i class="fas fa-money-check-alt"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-hand-holding-usd')" title="Hand Holding USD"><i class="fas fa-hand-holding-usd"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-landmark')" title="Landmark"><i class="fas fa-landmark"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-university')" title="University"><i class="fas fa-university"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-industry')" title="Industry"><i class="fas fa-industry"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-bar')" title="Chart Bar"><i class="fas fa-chart-bar"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-percent')" title="Percent"><i class="fas fa-percent"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-euro-sign')" title="Euro Sign"><i class="fas fa-euro-sign"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-pound-sign')" title="Pound Sign"><i class="fas fa-pound-sign"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-yen-sign')" title="Yen Sign"><i class="fas fa-yen-sign"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-ruble-sign')" title="Ruble Sign"><i class="fas fa-ruble-sign"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-lira-sign')" title="Lira Sign"><i class="fas fa-lira-sign"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-won-sign')" title="Won Sign"><i class="fas fa-won-sign"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-bitcoin')" title="Bitcoin"><i class="fab fa-bitcoin"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-ethereum')" title="Ethereum"><i class="fab fa-ethereum"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-server')" title="Server"><i class="fas fa-server"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-servers')" title="Servers"><i class="fas fa-servers"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-hdd')" title="HDD"><i class="fas fa-hdd"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-memory')" title="Memory"><i class="fas fa-memory"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-ethernet')" title="Ethernet"><i class="fas fa-ethernet"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-wifi')" title="WiFi"><i class="fas fa-wifi"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-satellite')" title="Satellite"><i class="fas fa-satellite"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-satellite-dish')" title="Satellite Dish"><i class="fas fa-satellite-dish"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-broadcast-tower')" title="Broadcast Tower"><i class="fas fa-broadcast-tower"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-sitemap')" title="Sitemap"><i class="fas fa-sitemap"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-project-diagram')" title="Project Diagram"><i class="fas fa-project-diagram"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-stream')" title="Stream"><i class="fas fa-stream"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-layer-group')" title="Layer Group"><i class="fas fa-layer-group"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-boxes')" title="Boxes"><i class="fas fa-boxes"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-cube')" title="Cube"><i class="fas fa-cube"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-cubes')" title="Cubes"><i class="fas fa-cubes"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-database')" title="Database"><i class="fas fa-database"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-table')" title="Table"><i class="fas fa-table"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-th')" title="Grid"><i class="fas fa-th"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-th-large')" title="Grid Large"><i class="fas fa-th-large"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-th-list')" title="List"><i class="fas fa-th-list"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-bars')" title="Bars"><i class="fas fa-bars"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-donut')" title="Chart Donut"><i class="fas fa-chart-donut"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-scatter')" title="Chart Scatter"><i class="fas fa-chart-scatter"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-gantt')" title="Chart Gantt"><i class="fas fa-chart-gantt"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-network')" title="Chart Network"><i class="fas fa-chart-network"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-tree')" title="Chart Tree"><i class="fas fa-chart-tree"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-waterfall')" title="Chart Waterfall"><i class="fas fa-chart-waterfall"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-radar')" title="Chart Radar"><i class="fas fa-chart-radar"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-bubble')" title="Chart Bubble"><i class="fas fa-chart-bubble"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-histogram')" title="Chart Histogram"><i class="fas fa-chart-histogram"></i></div>
                                <div class="icon-item" onclick="seleccionarIcono('fas fa-chart-column')" title="Chart Column"><i class="fas fa-chart-column"></i></div>
                                
                                <!-- Material Icons -->
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:analytics')" title="Material Icons - Analytics"><span class="material-icons">analytics</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:trending_up')" title="Material Icons - Trending Up"><span class="material-icons">trending_up</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:trending_down')" title="Material Icons - Trending Down"><span class="material-icons">trending_down</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:bar_chart')" title="Material Icons - Bar Chart"><span class="material-icons">bar_chart</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:pie_chart')" title="Material Icons - Pie Chart"><span class="material-icons">pie_chart</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:show_chart')" title="Material Icons - Show Chart"><span class="material-icons">show_chart</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:account_balance')" title="Material Icons - Account Balance"><span class="material-icons">account_balance</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:account_balance_wallet')" title="Material Icons - Account Balance Wallet"><span class="material-icons">account_balance_wallet</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:attach_money')" title="Material Icons - Attach Money"><span class="material-icons">attach_money</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:payment')" title="Material Icons - Payment"><span class="material-icons">payment</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:credit_card')" title="Material Icons - Credit Card"><span class="material-icons">credit_card</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:savings')" title="Material Icons - Savings"><span class="material-icons">savings</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:currency_exchange')" title="Material Icons - Currency Exchange"><span class="material-icons">currency_exchange</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:calculate')" title="Material Icons - Calculate"><span class="material-icons">calculate</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:receipt')" title="Material Icons - Receipt"><span class="material-icons">receipt</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:business')" title="Material Icons - Business"><span class="material-icons">business</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:storage')" title="Material Icons - Storage"><span class="material-icons">storage</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:cloud')" title="Material Icons - Cloud"><span class="material-icons">cloud</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:security')" title="Material Icons - Security"><span class="material-icons">security</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:lock')" title="Material Icons - Lock"><span class="material-icons">lock</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:vpn_key')" title="Material Icons - Vpn Key"><span class="material-icons">vpn_key</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:code')" title="Material Icons - Code"><span class="material-icons">code</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:settings')" title="Material Icons - Settings"><span class="material-icons">settings</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:build')" title="Material Icons - Build"><span class="material-icons">build</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:sync')" title="Material Icons - Sync"><span class="material-icons">sync</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:smart_toy')" title="Material Icons - Smart Toy"><span class="material-icons">smart_toy</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:memory')" title="Material Icons - Memory"><span class="material-icons">memory</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:phone_android')" title="Material Icons - Phone Android"><span class="material-icons">phone_android</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:computer')" title="Material Icons - Computer"><span class="material-icons">computer</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:laptop')" title="Material Icons - Laptop"><span class="material-icons">laptop</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:tablet')" title="Material Icons - Tablet"><span class="material-icons">tablet</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:print')" title="Material Icons - Print"><span class="material-icons">print</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:description')" title="Material Icons - Description"><span class="material-icons">description</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:folder')" title="Material Icons - Folder"><span class="material-icons">folder</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:archive')" title="Material Icons - Archive"><span class="material-icons">archive</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:search')" title="Material Icons - Search"><span class="material-icons">search</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:filter_list')" title="Material Icons - Filter List"><span class="material-icons">filter_list</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:sort')" title="Material Icons - Sort"><span class="material-icons">sort</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:notifications')" title="Material Icons - Notifications"><span class="material-icons">notifications</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:email')" title="Material Icons - Email"><span class="material-icons">email</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:send')" title="Material Icons - Send"><span class="material-icons">send</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:check_circle')" title="Material Icons - Check Circle"><span class="material-icons">check_circle</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:cancel')" title="Material Icons - Cancel"><span class="material-icons">cancel</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:info')" title="Material Icons - Info"><span class="material-icons">info</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:warning')" title="Material Icons - Warning"><span class="material-icons">warning</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:help')" title="Material Icons - Help"><span class="material-icons">help</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:person')" title="Material Icons - Person"><span class="material-icons">person</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:people')" title="Material Icons - People"><span class="material-icons">people</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:admin_panel_settings')" title="Material Icons - Admin Panel Settings"><span class="material-icons">admin_panel_settings</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:handshake')" title="Material Icons - Handshake"><span class="material-icons">handshake</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:language')" title="Material Icons - Language"><span class="material-icons">language</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:link')" title="Material Icons - Link"><span class="material-icons">link</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:link_off')" title="Material Icons - Link Off"><span class="material-icons">link_off</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:download')" title="Material Icons - Download"><span class="material-icons">download</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:upload')" title="Material Icons - Upload"><span class="material-icons">upload</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:save')" title="Material Icons - Save"><span class="material-icons">save</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:edit')" title="Material Icons - Edit"><span class="material-icons">edit</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:delete')" title="Material Icons - Delete"><span class="material-icons">delete</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:content_copy')" title="Material Icons - Content Copy"><span class="material-icons">content_copy</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:content_paste')" title="Material Icons - Content Paste"><span class="material-icons">content_paste</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:content_cut')" title="Material Icons - Content Cut"><span class="material-icons">content_cut</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:redo')" title="Material Icons - Redo"><span class="material-icons">redo</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:undo')" title="Material Icons - Undo"><span class="material-icons">undo</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:history')" title="Material Icons - History"><span class="material-icons">history</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:access_time')" title="Material Icons - Access Time"><span class="material-icons">access_time</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:calendar_today')" title="Material Icons - Calendar Today"><span class="material-icons">calendar_today</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:event')" title="Material Icons - Event"><span class="material-icons">event</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:event_available')" title="Material Icons - Event Available"><span class="material-icons">event_available</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:timer')" title="Material Icons - Timer"><span class="material-icons">timer</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:hourglass_empty')" title="Material Icons - Hourglass Empty"><span class="material-icons">hourglass_empty</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:speed')" title="Material Icons - Speed"><span class="material-icons">speed</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:bolt')" title="Material Icons - Bolt"><span class="material-icons">bolt</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:local_fire_department')" title="Material Icons - Local Fire Department"><span class="material-icons">local_fire_department</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:star')" title="Material Icons - Star"><span class="material-icons">star</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:diamond')" title="Material Icons - Diamond"><span class="material-icons">diamond</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:emoji_events')" title="Material Icons - Emoji Events"><span class="material-icons">emoji_events</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:military_tech')" title="Material Icons - Military Tech"><span class="material-icons">military_tech</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:workspace_premium')" title="Material Icons - Workspace Premium"><span class="material-icons">workspace_premium</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:card_membership')" title="Material Icons - Card Membership"><span class="material-icons">card_membership</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:school')" title="Material Icons - School"><span class="material-icons">school</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:menu_book')" title="Material Icons - Menu Book"><span class="material-icons">menu_book</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:book')" title="Material Icons - Book"><span class="material-icons">book</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:bookmark')" title="Material Icons - Bookmark"><span class="material-icons">bookmark</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:local_offer')" title="Material Icons - Local Offer"><span class="material-icons">local_offer</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:label')" title="Material Icons - Label"><span class="material-icons">label</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:flag')" title="Material Icons - Flag"><span class="material-icons">flag</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:flag_circle')" title="Material Icons - Flag Circle"><span class="material-icons">flag_circle</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:place')" title="Material Icons - Place"><span class="material-icons">place</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:explore')" title="Material Icons - Explore"><span class="material-icons">explore</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:directions')" title="Material Icons - Directions"><span class="material-icons">directions</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:route')" title="Material Icons - Route"><span class="material-icons">route</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:road')" title="Material Icons - Road"><span class="material-icons">road</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:signpost')" title="Material Icons - Signpost"><span class="material-icons">signpost</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:traffic')" title="Material Icons - Traffic"><span class="material-icons">traffic</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:stop')" title="Material Icons - Stop"><span class="material-icons">stop</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:play_arrow')" title="Material Icons - Play Arrow"><span class="material-icons">play_arrow</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:pause')" title="Material Icons - Pause"><span class="material-icons">pause</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:fast_forward')" title="Material Icons - Fast Forward"><span class="material-icons">fast_forward</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:fast_rewind')" title="Material Icons - Fast Rewind"><span class="material-icons">fast_rewind</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:skip_next')" title="Material Icons - Skip Next"><span class="material-icons">skip_next</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:skip_previous')" title="Material Icons - Skip Previous"><span class="material-icons">skip_previous</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:eject')" title="Material Icons - Eject"><span class="material-icons">eject</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:power_settings_new')" title="Material Icons - Power Settings New"><span class="material-icons">power_settings_new</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:power')" title="Material Icons - Power"><span class="material-icons">power</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:battery_full')" title="Material Icons - Battery Full"><span class="material-icons">battery_full</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:battery_charging_full')" title="Material Icons - Battery Charging Full"><span class="material-icons">battery_charging_full</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:battery_alert')" title="Material Icons - Battery Alert"><span class="material-icons">battery_alert</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:ev_station')" title="Material Icons - Ev Station"><span class="material-icons">ev_station</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:local_gas_station')" title="Material Icons - Local Gas Station"><span class="material-icons">local_gas_station</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:water_drop')" title="Material Icons - Water Drop"><span class="material-icons">water_drop</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:format_paint')" title="Material Icons - Format Paint"><span class="material-icons">format_paint</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:palette')" title="Material Icons - Palette"><span class="material-icons">palette</span></div>
                                <div class="icon-item" onclick="seleccionarIcono('material-icons:auto_awesome')" title="Material Icons - Auto Awesome"><span class="material-icons">auto_awesome</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <style>
                    .icon-item {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 12px;
                        border: 1px solid var(--border-color);
                        border-radius: 4px;
                        cursor: pointer;
                        transition: all 0.2s;
                        background: white;
                    }
                    .icon-item:hover {
                        background: var(--hover-bg);
                        border-color: var(--primary-color);
                        transform: scale(1.05);
                    }
                    .icon-item i,
                    .icon-item .material-icons {
                        font-size: 24px;
                        color: var(--text-primary);
                    }
                    .icon-item:hover i,
                    .icon-item:hover .material-icons {
                        color: var(--primary-color);
                    }
                    </style>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button type="submit" class="button"><%= (typeof isNew !== 'undefined' && isNew) ? 'Crear Funcionalidad' : 'Guardar Cambios' %></button>
                        <button type="button" class="btn" onclick="cancelarEdicion()">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </main>
    
    <%- include('../partials/footer') %>
    
    <script src="/js/main.js"></script>
    <script>
    let editMode = <%= typeof editMode !== 'undefined' && editMode ? true : false %>;

    function toggleEditMode() {
        const isNew = document.getElementById('isNew') && document.getElementById('isNew').value === 'true';
        if (isNew) return; // No permitir toggle si es nueva
        
        editMode = !editMode;
        const editForm = document.getElementById('editForm');
        const editBtn = document.getElementById('editBtn');
        const content = document.querySelector('.one-page-content');
        const header = document.querySelector('.one-page-header');
        const footer = document.querySelector('.one-page-footer');
        const actions = document.querySelector('.one-page-actions');
        
        if (editMode) {
            editForm.style.display = 'block';
            if (content) content.style.display = 'none';
            if (header) header.style.display = 'none';
            if (footer) footer.style.display = 'none';
            if (actions) actions.style.display = 'none';
            if (editBtn) editBtn.textContent = 'Cancelar Edición';
            // Scroll al formulario
            editForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            editForm.style.display = 'none';
            if (content) content.style.display = 'block';
            if (header) header.style.display = 'block';
            if (footer) footer.style.display = 'block';
            if (actions) actions.style.display = 'flex';
            if (editBtn) editBtn.textContent = 'Editar';
        }
    }
    
    // Funciones para el selector de iconos
    function seleccionarIcono(iconClass) {
        document.getElementById('editIcon').value = iconClass;
        actualizarPreviewIcono(iconClass);
        cerrarSelectorIconos();
    }
    
    function actualizarPreviewIcono(iconClass) {
        const preview = document.getElementById('iconPreview');
        if (iconClass && iconClass.trim() !== '') {
            // Verificar si es un data URI (PNG importado)
            if (iconClass.startsWith('data:image')) {
                preview.innerHTML = '<img src="' + iconClass + '" style="max-width: 48px; max-height: 48px; object-fit: contain;" alt="Icono PNG"><span style="font-size: 13px; color: var(--text-secondary); margin-left: 8px;">Icono PNG importado</span>';
            } else if (iconClass.startsWith('material-icons:')) {
                // Material Icons: formato "material-icons:icon_name"
                const iconName = iconClass.split(':')[1];
                preview.innerHTML = '<span class="material-icons" style="font-size: 24px; color: var(--primary-color);">' + iconName + '</span><span style="font-size: 13px; color: var(--text-secondary); margin-left: 8px;">' + iconClass + '</span>';
            } else {
                // Font Awesome u otros iconos
                preview.innerHTML = '<i class="' + iconClass + '" style="font-size: 24px; color: var(--primary-color);"></i><span style="font-size: 13px; color: var(--text-secondary); margin-left: 8px;">' + iconClass + '</span>';
            }
        } else {
            preview.innerHTML = '<span style="font-size: 13px; color: var(--text-secondary);">Ningún icono seleccionado</span>';
        }
    }
    
    function abrirSelectorIconos() {
        document.getElementById('iconSelectorModal').style.display = 'block';
    }
    
    function cerrarSelectorIconos() {
        document.getElementById('iconSelectorModal').style.display = 'none';
    }
    
    function filtrarIconos() {
        const searchTerm = document.getElementById('iconSearch').value.toLowerCase();
        const iconItems = document.querySelectorAll('.icon-item');
        iconItems.forEach(item => {
            const title = item.getAttribute('title') || '';
            if (title.toLowerCase().includes(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    function cargarIconoPNG(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (file.type !== 'image/png') {
            alert('Por favor, selecciona un archivo PNG');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64 = e.target.result;
            // Guardar como data URI en el campo de icono
            document.getElementById('editIcon').value = base64;
            actualizarPreviewIconoPNG(base64);
            cerrarSelectorIconos();
        };
        reader.readAsDataURL(file);
    }
    
    function actualizarPreviewIconoPNG(base64) {
        const preview = document.getElementById('iconPreview');
        preview.innerHTML = '<img src="' + base64 + '" style="max-width: 48px; max-height: 48px; object-fit: contain;" alt="Icono PNG"><span style="font-size: 13px; color: var(--text-secondary); margin-left: 8px;">Icono PNG importado</span>';
    }
    
    // Si editMode es true al cargar, activar el modo edición
    if (editMode) {
        const editForm = document.getElementById('editForm');
        const content = document.querySelector('.one-page-content');
        const header = document.querySelector('.one-page-header');
        const footer = document.querySelector('.one-page-footer');
        const actions = document.querySelector('.one-page-actions');
        const editBtn = document.getElementById('editBtn');
        if (editForm) editForm.style.display = 'block';
        if (content) content.style.display = 'none';
        if (header) header.style.display = 'none';
        if (footer) footer.style.display = 'none';
        if (actions) actions.style.display = 'none';
        if (editBtn) editBtn.textContent = 'Cancelar Edición';
        // Scroll al formulario
        setTimeout(() => {
            if (editForm) editForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    }
    
    // Actualizar preview cuando se cambia el input manualmente
    document.addEventListener('DOMContentLoaded', function() {
        const iconInput = document.getElementById('editIcon');
        if (iconInput) {
            iconInput.addEventListener('input', function() {
                actualizarPreviewIcono(this.value);
            });
        }
    });

    function cancelarEdicion() {
        const isNew = document.getElementById('isNew') && document.getElementById('isNew').value === 'true';
        if (isNew) {
            window.location.href = 'javascript:history.back()';
        } else {
            toggleEditMode();
        }
    }

    function agregarTagAlcance() {
        const container = document.getElementById('alcanceContainer');
        const index = container.children.length;
        const div = document.createElement('div');
        div.className = 'tag-edit-item';
        div.style.cssText = 'margin-bottom: 12px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--hover-bg);';
        div.innerHTML = '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;"><span style="font-weight: 500; font-size: 13px;">Tag ' + (index + 1) + '</span><button type="button" onclick="eliminarTagAlcance(this)" style="background: #d93025; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Eliminar</button></div><input type="text" class="tag-titulo-alcance" placeholder="Título (opcional)" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px; font-size: 14px; font-family: \'Google Sans\', \'Roboto\', sans-serif;"><textarea class="tag-descripcion" placeholder="Descripción" rows="2" lang="es" spellcheck="true" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; font-family: \'Google Sans\', \'Roboto\', sans-serif;"></textarea><div style="margin-top: 8px;"><label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-secondary);">Imagen (opcional)</label><input type="file" class="tag-imagen-alcance" accept="image/*" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px;" onchange="previewAlcanceImage(this, ' + index + ')"><div class="alcance-image-preview" id="alcancePreview' + index + '" style="display: none; margin-top: 8px;"></div><input type="hidden" class="tag-imagen-data" value=""></div>';
        container.appendChild(div);
    }

    function eliminarTagAlcance(btn) {
        btn.closest('.tag-edit-item').remove();
    }
    
    function previewAlcanceImage(input, index) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewDiv = document.getElementById('alcancePreview' + index);
                const hiddenInput = input.closest('.tag-edit-item').querySelector('.tag-imagen-data');
                if (previewDiv && hiddenInput) {
                    previewDiv.style.display = 'block';
                    previewDiv.innerHTML = '<img src="' + e.target.result + '" style="max-width: 200px; max-height: 150px; border-radius: 4px; border: 1px solid var(--border-color);" /><button type="button" onclick="eliminarAlcanceImage(' + index + ')" style="margin-left: 8px; padding: 4px 8px; background: #d93025; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Eliminar imagen</button>';
                    hiddenInput.value = e.target.result;
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    function eliminarAlcanceImage(index) {
        const previewDiv = document.getElementById('alcancePreview' + index);
        const hiddenInput = previewDiv ? previewDiv.closest('.tag-edit-item').querySelector('.tag-imagen-data') : null;
        const fileInput = previewDiv ? previewDiv.closest('.tag-edit-item').querySelector('.tag-imagen-alcance') : null;
        if (previewDiv) previewDiv.style.display = 'none';
        if (previewDiv) previewDiv.innerHTML = '';
        if (hiddenInput) hiddenInput.value = '';
        if (fileInput) fileInput.value = '';
    }
    
    function previewAlcanceSectionImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewDiv = document.getElementById('alcanceSectionImagePreview');
                const previewImg = document.getElementById('alcanceSectionImagePreviewImg');
                const hiddenInput = document.getElementById('alcanceSectionImageData');
                if (previewDiv && previewImg && hiddenInput) {
                    previewDiv.style.display = 'block';
                    previewImg.src = e.target.result;
                    hiddenInput.value = e.target.result;
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    function eliminarAlcanceSectionImage() {
        const previewDiv = document.getElementById('alcanceSectionImagePreview');
        const previewImg = document.getElementById('alcanceSectionImagePreviewImg');
        const hiddenInput = document.getElementById('alcanceSectionImageData');
        const fileInput = document.getElementById('alcanceSectionImage');
        if (previewDiv) previewDiv.style.display = 'none';
        if (previewImg) previewImg.src = '';
        if (hiddenInput) hiddenInput.value = '';
        if (fileInput) fileInput.value = '';
    }

    function agregarTagVentajas() {
        const container = document.getElementById('ventajasContainer');
        const index = container.children.length;
        const div = document.createElement('div');
        div.className = 'tag-edit-item';
        div.style.cssText = 'margin-bottom: 12px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--hover-bg);';
        div.innerHTML = '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;"><span style="font-weight: 500; font-size: 13px;">Tag ' + (index + 1) + '</span><button type="button" onclick="eliminarTagVentajas(this)" style="background: #d93025; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Eliminar</button></div><input type="text" class="tag-titulo" placeholder="Título" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px; font-size: 14px;"><textarea class="tag-descripcion" placeholder="Descripción" rows="2" lang="es" spellcheck="true" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; font-family: \'Google Sans\', \'Roboto\', sans-serif;"></textarea>';
        container.appendChild(div);
    }

    function eliminarTagVentajas(btn) {
        btn.closest('.tag-edit-item').remove();
    }

    async function guardarEdicion(event) {
        event.preventDefault();
        
        const id = document.getElementById('editId').value;
        const isNew = document.getElementById('isNew').value === 'true';
        
        // Obtener partes interesadas seleccionadas
        const checkboxes = document.querySelectorAll('.stakeholder-checkbox:checked');
        const partesInteresadas = Array.from(checkboxes).map(cb => cb.value);
        
        // Obtener tags de alcance (con título opcional)
        const alcanceItems = Array.from(document.querySelectorAll('#alcanceContainer .tag-edit-item')).map(item => {
            const titulo = item.querySelector('.tag-titulo-alcance') ? item.querySelector('.tag-titulo-alcance').value.trim() : '';
            const descripcion = item.querySelector('.tag-descripcion').value;
            if (descripcion || titulo) {
                const result = { descripcion };
                if (titulo) result.titulo = titulo;
                return result;
            }
            return null;
        }).filter(item => item !== null);
        
        // Obtener imagen de sección Alcance
        const alcanceImagen = document.getElementById('alcanceSectionImageData') ? document.getElementById('alcanceSectionImageData').value : '';
        
        // Obtener tags de ventajas
        const ventajasItems = Array.from(document.querySelectorAll('#ventajasContainer .tag-edit-item')).map(item => {
            const titulo = item.querySelector('.tag-titulo').value;
            const descripcion = item.querySelector('.tag-descripcion').value;
            if (titulo || descripcion) {
                return { titulo, descripcion };
            }
            return null;
        }).filter(item => item !== null);
        
        const data = {
            title: document.getElementById('editTitle').value,
            description: document.getElementById('editDescription').value,
            alcance: alcanceItems,
            alcance_imagen: alcanceImagen,
            ventajas_esperadas: ventajasItems,
            type: document.getElementById('editType').value,
            section: document.getElementById('editSection').value,
            icon: document.getElementById('editIcon').value,
            partes_interesadas: partesInteresadas
        };
        
        try {
            const url = isNew ? '/api/funcionalidades' : '/api/funcionalidades/' + id;
            const method = isNew ? 'POST' : 'PUT';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Redireccionar sin mostrar popup
                if (isNew && result.funcionalidad && result.funcionalidad.slug) {
                    window.location.href = '/detalle/' + result.funcionalidad.slug;
                } else {
                    // Redireccionar a la sección correspondiente según el tipo
                    const type = document.getElementById('editType').value;
                    let redirectUrl = '/newsletter'; // Por defecto
                    
                    if (type === 'catalogo') {
                        redirectUrl = '/catalogo';
                    } else if (type === 'newsletter') {
                        redirectUrl = '/newsletter';
                    } else if (type === 'proximamente') {
                        redirectUrl = '/proximamente';
                    }
                    
                    window.location.href = redirectUrl;
                }
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al guardar los cambios');
        }
    }
    </script>
</body>
</html>
